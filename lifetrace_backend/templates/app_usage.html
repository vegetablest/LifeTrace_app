<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº”ç”¨ä½¿ç”¨åˆ†æ - LifeTrace</title>
    <!-- Lucide Icons - æœ¬åœ°åŒ–ç‰ˆæœ¬ -->
    <script src="/static/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96%;
            --secondary-foreground: 222.2 84% 4.9%;
            --muted: 210 40% 96%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96%;
            --accent-foreground: 222.2 84% 4.9%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
        }

        [data-theme="dark"] {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 84% 4.9%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 94.1%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid hsl(var(--border));
            background: hsl(var(--background));
        }

        .header-content {
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 0 1rem;
            max-width: 80rem;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-logo {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border-radius: var(--radius);
        }

        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-ghost {
            background: transparent;
            color: hsl(var(--foreground));
        }

        .btn-ghost:hover {
            background: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
        }

        .btn-outline {
            background: transparent;
            color: hsl(var(--foreground));
            border: 1px solid hsl(var(--border));
        }

        .btn-outline:hover {
            background: hsl(var(--accent));
            color: hsl(var(--accent-foreground));
        }

        .btn-primary {
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        .btn-primary:hover {
            background: hsl(var(--primary) / 0.9);
        }

        .container {
            max-width: 80rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-description {
            color: hsl(var(--muted-foreground));
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--muted-foreground));
        }

        .stat-icon {
            width: 1rem;
            height: 1rem;
            color: hsl(var(--muted-foreground));
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-change {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }

        .chart-container {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: hsl(var(--muted-foreground));
        }

        .error {
            color: hsl(var(--destructive));
            text-align: center;
            padding: 2rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .app-list {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .app-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid hsl(var(--border));
        }

        .app-item:last-child {
            border-bottom: none;
        }

        .app-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .app-icon {
            width: 2rem;
            height: 2rem;
            background: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .app-name {
            font-weight: 500;
        }

        .app-stats {
            text-align: right;
        }

        .app-time {
            font-weight: 600;
            color: hsl(var(--primary));
        }

        .app-sessions {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }

            .app-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .app-stats {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-logo">
                    <i data-lucide="monitor"></i>
                </div>
                <span class="header-title">åº”ç”¨ä½¿ç”¨åˆ†æ</span>
            </div>
            <div class="header-right">
                <button class="btn btn-ghost btn-icon" id="themeToggle">
                    <i data-lucide="moon" id="themeIcon"></i>
                </button>
                <a href="/analytics" class="btn btn-outline">è¡Œä¸ºåˆ†æ</a>
                <a href="/chat" class="btn btn-outline">èŠå¤©</a>
                <a href="/" class="btn btn-outline">é¦–é¡µ</a>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">åº”ç”¨ä½¿ç”¨åˆ†æ</h1>
        <p class="page-description">åˆ†ææ‚¨çš„è®¡ç®—æœºåº”ç”¨ä½¿ç”¨æƒ…å†µï¼Œäº†è§£æ—¶é—´åˆ†é…å’Œä½¿ç”¨ä¹ æƒ¯</p>

        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">æ—¶é—´èŒƒå›´</label>
                <select id="daysFilter" class="filter-select">
                    <option value="1">ä»Šå¤©</option>
                    <option value="7" selected>æœ€è¿‘7å¤©</option>
                    <option value="30">æœ€è¿‘30å¤©</option>
                </select>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">æ€»ä½¿ç”¨æ—¶é•¿</span>
                    <i data-lucide="clock" class="stat-icon"></i>
                </div>
                <div class="stat-value" id="totalUsageTime">-</div>
                <div class="stat-change">å°æ—¶</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">ä½¿ç”¨åº”ç”¨æ•°</span>
                    <i data-lucide="grid-3x3" class="stat-icon"></i>
                </div>
                <div class="stat-value" id="totalAppsUsed">-</div>
                <div class="stat-change">ä¸ªåº”ç”¨</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">åº”ç”¨åˆ‡æ¢æ¬¡æ•°</span>
                    <i data-lucide="shuffle" class="stat-icon"></i>
                </div>
                <div class="stat-value" id="appSwitches">-</div>
                <div class="stat-change">æ¬¡åˆ‡æ¢</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">å¹³å‡ä¼šè¯æ—¶é•¿</span>
                    <i data-lucide="timer" class="stat-icon"></i>
                </div>
                <div class="stat-value" id="avgSessionTime">-</div>
                <div class="stat-change">åˆ†é’Ÿ</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="chart-container">
            <h2 class="chart-title">åº”ç”¨ä½¿ç”¨æ—¶é•¿åˆ†å¸ƒ</h2>
            <div class="chart-wrapper">
                <canvas id="appUsageChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">å°æ—¶ä½¿ç”¨åˆ†å¸ƒ</h2>
            <div class="chart-wrapper">
                <canvas id="hourlyUsageChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ä¸»é¢˜åˆ‡æ¢
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const body = document.body;

        function updateTheme() {
            const isDark = body.getAttribute('data-theme') === 'dark';
            themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            setTimeout(initIcons, 100);
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateTheme();
        });

        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        updateTheme();

        // å›¾è¡¨å®ä¾‹
        let appUsageChart = null;
        let hourlyUsageChart = null;

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(minutes) {
            if (minutes < 60) {
                return `${Math.round(minutes)}åˆ†é’Ÿ`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return mins > 0 ? `${hours}å°æ—¶${mins}åˆ†é’Ÿ` : `${hours}å°æ—¶`;
            }
        }

        // è·å–åº”ç”¨ä½¿ç”¨ç»Ÿè®¡æ•°æ®
        async function fetchAppUsageStats() {
            try {
                const days = document.getElementById('daysFilter').value;
                
                const params = new URLSearchParams({
                    days: days
                });

                const response = await fetch(`/api/app-usage-stats?${params}`);
                if (!response.ok) {
                    throw new Error('è·å–æ•°æ®å¤±è´¥');
                }
                
                const data = await response.json();
                updateStats(data);
                updateCharts(data);
            } catch (error) {
                console.error('è·å–åº”ç”¨ä½¿ç”¨ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showError('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats(data) {
            document.getElementById('totalUsageTime').textContent = 
                (data.total_usage_time / 3600).toFixed(1);
            document.getElementById('totalAppsUsed').textContent = data.total_apps_used;
            document.getElementById('appSwitches').textContent = 
                data.app_switching_patterns?.total_switches || 0;
            
            const avgSession = data.app_switching_patterns?.avg_session_duration || 0;
            document.getElementById('avgSessionTime').textContent = 
                Math.round(avgSession);
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            updateAppUsageChart(data.top_apps_by_time);
            updateHourlyUsageChart(data.hourly_app_distribution);
        }

        // åº”ç”¨ä½¿ç”¨æ—¶é•¿åˆ†å¸ƒå›¾è¡¨
        function updateAppUsageChart(topApps) {
            const ctx = document.getElementById('appUsageChart').getContext('2d');
            
            if (appUsageChart) {
                appUsageChart.destroy();
            }

            const labels = topApps.slice(0, 10).map(app => app.app_name);
            const data = topApps.slice(0, 10).map(app => app.total_time / 3600); // è½¬æ¢ä¸ºå°æ—¶

            // ç°ä»£åŒ–æ¸å˜è‰²å½©æ–¹æ¡ˆ
            const gradientColors = [
                { start: '#667eea', end: '#764ba2' }, // ç´«è“æ¸å˜
                { start: '#f093fb', end: '#f5576c' }, // ç²‰çº¢æ¸å˜
                { start: '#4facfe', end: '#00f2fe' }, // è“é’æ¸å˜
                { start: '#43e97b', end: '#38f9d7' }, // ç»¿é’æ¸å˜
                { start: '#fa709a', end: '#fee140' }, // ç²‰é»„æ¸å˜
                { start: '#a8edea', end: '#fed6e3' }, // é’ç²‰æ¸å˜
                { start: '#ff9a9e', end: '#fecfef' }, // çº¢ç²‰æ¸å˜
                { start: '#ffecd2', end: '#fcb69f' }, // é»„æ©™æ¸å˜
                { start: '#a18cd1', end: '#fbc2eb' }, // ç´«ç²‰æ¸å˜
                { start: '#fad0c4', end: '#ffd1ff' }  // æ©™ç²‰æ¸å˜
            ];

            // åˆ›å»ºæ¸å˜èƒŒæ™¯
            const backgroundColors = gradientColors.slice(0, labels.length).map(color => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color.start);
                gradient.addColorStop(1, color.end);
                return gradient;
            });

            // æ‚¬åœæ—¶çš„è¾¹æ¡†é¢œè‰²
            const hoverBorderColors = gradientColors.slice(0, labels.length).map(color => color.start);

            appUsageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderColor: hoverBorderColors,
                        hoverBorderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%', // å¢å¤§å†…åœ†ï¼Œæ›´ç°ä»£çš„å¤–è§‚
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', 'Segoe UI', sans-serif"
                                },
                                color: 'hsl(var(--foreground))',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const dataset = data.datasets[0];
                                            const value = dataset.data[i];
                                            const total = dataset.data.reduce((sum, val) => sum + val, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: gradientColors[i]?.start || '#ccc',
                                                strokeStyle: gradientColors[i]?.start || '#ccc',
                                                lineWidth: 0,
                                                pointStyle: 'circle',
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    const hours = value.toFixed(1);
                                    return [`ä½¿ç”¨æ—¶é•¿: ${hours} å°æ—¶`, `å æ¯”: ${percentage}%`];
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    },
                    elements: {
                        arc: {
                            borderRadius: 4,
                            hoverBorderRadius: 6
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        // å°æ—¶ä½¿ç”¨åˆ†å¸ƒå›¾è¡¨
        function updateHourlyUsageChart(hourlyData) {
            const ctx = document.getElementById('hourlyUsageChart').getContext('2d');
            
            if (hourlyUsageChart) {
                hourlyUsageChart.destroy();
            }

            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const data = labels.map((_, hour) => {
                // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†åµŒå¥—çš„å°æ—¶æ•°æ®ç»“æ„
                if (hourlyData[hour] && typeof hourlyData[hour] === 'object') {
                    // è®¡ç®—è¯¥å°æ—¶å†…æ‰€æœ‰åº”ç”¨çš„æ€»ä½¿ç”¨æ—¶é•¿
                    const totalSeconds = Object.values(hourlyData[hour]).reduce((sum, duration) => sum + duration, 0);
                    return totalSeconds / 3600; // è½¬æ¢ä¸ºå°æ—¶
                }
                return 0;
            });

            console.log('å°æ—¶ä½¿ç”¨åˆ†å¸ƒæ•°æ®:', data); // è°ƒè¯•æ—¥å¿—

            // åˆ›å»ºæ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');   // è“è‰²é¡¶éƒ¨
            gradient.addColorStop(0.5, 'rgba(147, 51, 234, 0.6)'); // ç´«è‰²ä¸­éƒ¨
            gradient.addColorStop(1, 'rgba(236, 72, 153, 0.4)');   // ç²‰è‰²åº•éƒ¨

            // åˆ›å»ºè¾¹æ¡†æ¸å˜
            const borderGradient = ctx.createLinearGradient(0, 0, 0, 400);
            borderGradient.addColorStop(0, 'rgba(59, 130, 246, 1)');
            borderGradient.addColorStop(0.5, 'rgba(147, 51, 234, 1)');
            borderGradient.addColorStop(1, 'rgba(236, 72, 153, 1)');

            hourlyUsageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ä½¿ç”¨æ—¶é•¿ (å°æ—¶)',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: borderGradient,
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        hoverBackgroundColor: 'rgba(59, 130, 246, 0.9)',
                        hoverBorderColor: 'rgba(59, 130, 246, 1)',
                        hoverBorderWidth: 3,
                        shadowOffsetX: 0,
                        shadowOffsetY: 4,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.15)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#f9fafb',
                            bodyColor: '#f3f4f6',
                            borderColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 16,
                            displayColors: false,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    const hour = context[0].label;
                                    return `ğŸ“Š ${hour} æ—¶æ®µ`;
                                },
                                label: function(context) {
                                    const hours = context.parsed.y.toFixed(2);
                                    const minutes = Math.round(context.parsed.y * 60);
                                    const seconds = Math.round(context.parsed.y * 3600);
                                    
                                    if (hours >= 1) {
                                        return `â±ï¸ ä½¿ç”¨æ—¶é•¿: ${hours} å°æ—¶`;
                                    } else if (minutes >= 1) {
                                        return `â±ï¸ ä½¿ç”¨æ—¶é•¿: ${minutes} åˆ†é’Ÿ`;
                                    } else {
                                        return `â±ï¸ ä½¿ç”¨æ—¶é•¿: ${seconds} ç§’`;
                                    }
                                },
                                afterLabel: function(context) {
                                    const percentage = ((context.parsed.y / Math.max(...data)) * 100).toFixed(1);
                                    return `ğŸ“ˆ å æ¯”: ${percentage}%`;
                                }
                            },
                            animation: {
                                duration: 200
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ä½¿ç”¨æ—¶é•¿ (å°æ—¶)',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'h';
                                },
                                color: '#9ca3af',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)',
                                lineWidth: 1
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´æ®µ',
                                color: '#6b7280',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#9ca3af',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                display: false
                            },
                            border: {
                                color: 'rgba(156, 163, 175, 0.2)'
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutCubic',
                        delay: (context) => {
                            return context.dataIndex * 50; // é€ä¸ªæŸ±çŠ¶å›¾åŠ¨ç”»
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    elements: {
                        bar: {
                            borderRadius: 8,
                            hoverBorderRadius: 10
                        }
                    }
                },
                plugins: [{
                    id: 'customShadow',
                    beforeDraw: (chart) => {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                        ctx.shadowBlur = 10;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 4;
                    },
                    afterDraw: (chart) => {
                        chart.ctx.restore();
                    }
                }]
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('daysFilter').addEventListener('change', fetchAppUsageStats);

        // æ”¹è¿›çš„å›¾æ ‡åˆå§‹åŒ–å‡½æ•°
        function initIcons() {
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                    console.log('âœ“ Lucide icons loaded successfully');
                } catch (e) {
                    console.error('âœ— Error creating icons:', e);
                }
            } else {
                console.warn('âœ— Lucide library not loaded, retrying in 1s...');
                setTimeout(function() {
                    if (typeof lucide !== 'undefined') {
                        try {
                            lucide.createIcons();
                            console.log('âœ“ Lucide icons loaded successfully (retry)');
                        } catch (e) {
                            console.error('âœ— Error creating icons on retry:', e);
                        }
                    } else {
                        console.error('âœ— Failed to load Lucide icons library. Please check your network connection.');
                    }
                }, 1000);
            }
        }

        // åˆå§‹åŒ–å›¾æ ‡
        initIcons();

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            fetchAppUsageStats();
        });
    </script>
</body>
</html>