# 事件上下文聊天功能使用指南

## 功能概述

该功能允许用户在"忆往昔"（Time Machine）页面选择多个事件，将这些事件的OCR文本内容作为上下文提供给聊天助手，从而获得基于这些历史记录的精准回答。

## 前端测试步骤

### 1. 启动服务

```bash
conda activate laptop_showcase
python -m lifetrace_backend.server
```

### 2. 访问Web界面

打开浏览器访问：`http://localhost:8840`

### 3. 打开忆往昔面板

点击左侧导航栏的"忆往昔"图标（时钟图标），展开事件时间轴。

### 4. 选择事件

- 在事件列表中，每个事件项左侧都有一个复选框
- 勾选2-3个感兴趣的事件（建议选择内容丰富的事件）
- 勾选后，事件项会高亮显示

### 5. 查看上下文标签

在聊天输入框上方会自动出现一个蓝色的上下文区域，显示：
- 📋 上下文事件 (X) - X表示选中的事件数量
- 每个选中的事件会显示为一个蓝色标签，包含应用名称
- 如果文本被截断（超过30000字符），会显示 ✂️ 图标

### 6. 与AI对话

在聊天输入框中输入问题，例如：
- "总结一下这些事件的主要内容"
- "我当时在做什么？"
- "帮我分析一下这段时间的活动"

AI会基于选中事件的OCR文本内容进行回答。

### 7. 管理上下文

- **移除单个事件**：点击标签右侧的 × 按钮
- **清空所有上下文**：点击"清空"按钮
- 移除事件后，对应的复选框会自动取消勾选

## 技术细节

### 前端实现

1. **上下文容器** (`#eventContextContainer`)
   - 位于聊天输入框上方
   - 仅在有选中事件时显示

2. **事件选择监听**
   - 监听 `eventsSelectionChanged` 自定义事件
   - 自动获取选中事件的上下文数据

3. **上下文聚合**
   - 调用 `/api/events/{event_id}/context` API获取每个事件的OCR文本
   - 最大上下文长度限制：30000字符
   - 超出部分会被截断并显示提示

4. **API端点选择**
   - 无上下文：`/api/chat/stream`
   - 有上下文：`/api/chat/stream-with-context`

### 后端实现

1. **GET /api/events/{event_id}/context**
   - 返回事件的基本信息和所有截图的OCR文本
   - 响应格式：
     ```json
     {
       "event_id": 123,
       "app_name": "Chrome",
       "window_title": "文档标题",
       "start_time": "2025-10-11T10:00:00",
       "end_time": "2025-10-11T10:05:00",
       "ocr_texts": ["文本1", "文本2", ...],
       "screenshot_count": 10
     }
     ```

2. **POST /api/chat/stream-with-context**
   - 接收消息和事件上下文数组
   - 构建增强型提示词，包含事件上下文
   - 使用RAG服务进行流式生成
   - 记录Token使用量（包含上下文事件数）

### 性能考虑

- **上下文大小限制**：30000字符（约15000个中文字符）
- **推荐事件数量**：2-5个事件
- **自动截断**：超出限制的文本会被截断
- **内存优化**：使用流式响应，避免一次性加载大量数据

## 常见问题

### Q: 为什么选中事件后没有显示上下文标签？

A: 请检查：
1. 浏览器控制台是否有错误
2. 事件是否有OCR文本内容
3. 网络请求是否成功（F12 Network标签）

### Q: AI的回答没有使用我提供的上下文？

A: 请确认：
1. 上下文标签是否正确显示
2. 检查浏览器控制台是否输出 `[Chat] 使用事件上下文，事件数: X`
3. 后端日志是否显示 `[stream-with-context] 收到消息`

### Q: 上下文文本被截断了怎么办？

A:
1. 减少选中的事件数量
2. 选择截图数量较少的事件
3. 30000字符的限制是为了避免超出LLM的上下文窗口

## 未来改进方向

1. **智能摘要**：对长文本进行预处理和摘要
2. **相关性排序**：根据用户问题自动选择最相关的事件
3. **多模态支持**：除了文本，还可以包含截图的视觉信息
4. **持久化会话**：保存选中的上下文，跨会话使用

## 日志和调试

### 前端日志

打开浏览器控制台（F12），查看：
- `[Chat] 使用事件上下文，事件数: X` - 表示正在使用上下文
- 错误信息和网络请求详情

### 后端日志

查看 `data/logs/core/` 目录下的最新日志文件：
- `[stream-with-context] 收到消息` - 接收到带上下文的请求
- `[stream-with-context] Token使用量已记录` - 请求处理完成

## 测试API

可以使用 `test_event_context_feature.py` 脚本进行后端API测试：

```bash
conda activate laptop_showcase
python test_event_context_feature.py
```

该脚本会测试：
1. 获取事件上下文API
2. 带上下文的流式聊天API
3. 普通流式聊天API（对比）
