# 智能事件切分功能说明

## 📋 功能概述

LifeTrace现在支持**智能事件切分**，能够根据应用类型和窗口标题变化，自动将用户活动切分为更精细的事件。

## 🎯 解决的问题

### 旧版本问题

**场景：** 在Chrome浏览器中依次访问GitHub、Google、YouTube

```
❌ 旧逻辑：所有活动被算作1个事件
- 标题只保留最后一个："YouTube - Music"
- AI摘要会混合所有内容，不够精准
```

### 新版本改进

```
✅ 新逻辑：自动切分为3个独立事件
- 事件1：浏览GitHub（标题："GitHub - LifeTrace"）
- 事件2：搜索Google（标题："Google - Search"）
- 事件3：观看YouTube（标题："YouTube - Music"）
- 每个事件的AI摘要都很精准
```

## 🧠 智能策略

### 标题敏感应用

以下应用会根据窗口标题变化来切分事件：

- **浏览器**：Chrome、Edge、Firefox、Brave、Opera、Safari
- **文件管理器**：Explorer
- **聊天工具**：WeChat（聊天对象切换）

### 标题不敏感应用

以下应用在同一应用内保持同一事件：

- **编辑器**：VSCode、Sublime Text、Notepad++
- **Office**：Word、Excel、PowerPoint
- **开发工具**：PyCharm、IntelliJ IDEA
- **其他应用**：默认行为

## 📊 相似度算法

### 计算逻辑

```python
相似度 = 0.0 - 1.0

判断规则：
- 完全相同 → 1.0
- 提取关键部分相同 → 0.8
- 字符串包含关系 → 0.5
- 共同词占比 → 0.0-1.0

阈值：0.3
- 相似度 < 0.3 → 创建新事件
- 相似度 ≥ 0.3 → 复用事件
```

### 示例

| 标题1 | 标题2 | 相似度 | 结果 |
|------|------|--------|------|
| "GitHub - LifeTrace" | "GitHub - Issues" | 0.8 | 复用事件 |
| "GitHub - LifeTrace" | "YouTube - Music" | 0.0 | 创建新事件 |
| "Google Search" | "Google Maps" | 0.8 | 复用事件 |
| "文档1.docx - Word" | "文档2.docx - Word" | 0.8 | 复用事件 |
| "main.py - VSCode" | "utils.py - VSCode" | 1.0 | 复用事件（编辑器） |

## 🔧 实现细节

### 核心文件

**文件：** `lifetrace_backend/storage.py`

### 核心方法

#### 1. `_calculate_title_similarity(title1, title2)`

计算两个标题的相似度。

**特点：**
- 提取网站名或应用主题作为关键部分
- 支持多种分隔符（`-`、`|`）
- 计算共同词占比

#### 2. `_should_reuse_event(old_app, old_title, new_app, new_title)`

判断是否应该复用事件。

**策略：**
1. 应用名不同 → 不复用
2. 标题敏感应用 → 计算相似度判断
3. 其他应用 → 复用

#### 3. `get_or_create_event(app_name, window_title, timestamp)`

主入口方法，调用上述辅助方法进行判断。

## 🎨 使用效果

### 场景1：浏览网页

```
10:00  Chrome  "GitHub - LifeTrace"      → 事件1
10:05  Chrome  "GitHub - Issues"         → 事件1（相似度0.8）
10:10  Chrome  "YouTube - Music"         → 事件2（相似度0.0）
10:15  Chrome  "YouTube - Trending"      → 事件2（相似度0.8）
```

**AI摘要效果：**
- 事件1：`查看**GitHub**项目仓库和问题列表`
- 事件2：`浏览**YouTube**音乐和热门视频`

### 场景2：编写代码

```
11:00  VSCode  "main.py - VSCode"        → 事件1
11:05  VSCode  "utils.py - VSCode"       → 事件1（编辑器，保持同一事件）
11:10  VSCode  "config.yaml - VSCode"    → 事件1
```

**AI摘要效果：**
- 事件1：`使用**VSCode**开发Python项目`

### 场景3：混合工作流

```
12:00  VSCode  "main.py"                 → 事件1
12:10  Chrome  "Stack Overflow - Python" → 事件2（应用切换）
12:15  Chrome  "GitHub - Examples"       → 事件3（不同网站）
12:20  VSCode  "main.py"                 → 事件4（应用切换）
```

**AI摘要效果：**
- 事件1：`编写Python代码`
- 事件2：`在**Stack Overflow**查找Python问题解决方案`
- 事件3：`浏览**GitHub**示例代码`
- 事件4：`继续编写Python代码`

## ⚙️ 配置选项

### 调整相似度阈值

编辑 `lifetrace_backend/storage.py` 第264行：

```python
threshold = 0.3  # 默认值，可调整为 0.1-0.9
```

**建议值：**
- `0.1` - 非常宽松，几乎任何相似都复用（事件少）
- `0.3` - 默认值，平衡精细度和合理性 ⭐
- `0.5` - 中等严格，只有较相似才复用
- `0.9` - 非常严格，几乎不复用（事件多）

### 添加/移除标题敏感应用

编辑 `lifetrace_backend/storage.py` 第248-253行：

```python
TITLE_SENSITIVE_APPS = [
    'chrome.exe', 'msedge.exe', 'firefox.exe',  # 浏览器
    'explorer.exe',  # 文件管理器
    'wechat.exe',    # 微信
    # 添加其他应用...
]
```

## 📈 性能影响

- **CPU占用**：几乎无影响（简单字符串比较）
- **内存占用**：<1KB（临时计算）
- **延迟**：<1ms（不影响截图速度）
- **数据库**：无额外表或字段

## 🔍 调试信息

启用DEBUG日志可以看到详细的判断过程：

```python
# 在 lifetrace_backend/storage.py 第267-269行
logging.debug(f"标题敏感应用 {app_lower}: 相似度={similarity:.2f}, 阈值={threshold}, 复用={should_reuse}")
logging.debug(f"  旧标题: {old_title}")
logging.debug(f"  新标题: {new_title}")
```

**示例输出：**
```
标题敏感应用 chrome.exe: 相似度=0.80, 阈值=0.30, 复用=True
  旧标题: GitHub - LifeTrace
  新标题: GitHub - Issues

标题敏感应用 chrome.exe: 相似度=0.00, 阈值=0.30, 复用=False
  旧标题: GitHub - Issues
  新标题: YouTube - Music
```

## 🚀 后续优化方向

1. **机器学习分类**：基于内容自动学习最佳切分策略
2. **用户自定义**：允许用户配置特定应用的切分行为
3. **时间维度**：超过N分钟无活动自动切分事件
4. **内容相关性**：结合OCR内容判断是否相关
5. **多窗口支持**：同时打开多个窗口的场景

## 📚 相关文档

- [事件机制完整说明](event_mechanism.md)
- [事件AI摘要功能](event_ai_summary_usage.md)

---

**版本：** 1.0  
**更新日期：** 2025-10-11  
**作者：** LifeTrace团队

