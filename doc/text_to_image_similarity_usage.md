# 文本与图像相似度计算程序使用说明

## 程序简?
`text_to_image_similarity.py` 是一个基于CLIP多模态模型的文本与图像相似度计算程序。它已集成到LifeTrace系统中，可以?
- 输入任意文本查询
- 计算与数据库中所有图像的语义相似?- 返回按相似度排序的结果列?- 显示详细的图像信息和OCR文本内容
- 支持Web API和命令行两种使用方式

## 功能特点

1. **多模态语义搜?*：基于CLIP模型，理解文本和图像的语义关?2. **相似度计?*：使用改进的相似度公?`1.0 / (1.0 + distance)` 处理各种距离?3. **详细信息展示**：显示图像路径、OCR文本、应用程序、窗口标题等
4. **灵活的结果控?*：支持限制返回数量和详细信息显示

## 使用方法

### Web API方式（推荐）

通过LifeTrace Web服务使用多模态搜索：

```bash
# 启动LifeTrace服务
python -m lifetrace_backend.server --port 8843

# 使用API进行搜索
curl -X POST http://localhost:8843/api/multimodal-search \
  -H "Content-Type: application/json" \
  -d '{"query": "电脑", "top_k": 10, "text_weight": 0.6, "image_weight": 0.4}'
```

### 命令行方?
```bash
python text_to_image_similarity.py "查询文本"
```

### 命令行参?
- `query`：必需参数，查询文?- `--limit N`：限制返回结果数量为N?- `--details`：显示详细信息（应用程序、窗口标题、创建时间等?- `--verbose`：显示详细日志输?
### 使用示例

#### 1. 基本搜索
```bash
python text_to_image_similarity.py "电脑"
```

#### 2. 限制结果数量
```bash
python text_to_image_similarity.py "网页" --limit 5
```

#### 3. 显示详细信息
```bash
python text_to_image_similarity.py "浏览? --details
```

#### 4. 详细日志输出
```bash
python text_to_image_similarity.py "文档" --verbose
```

#### 5. 组合使用
```bash
python text_to_image_similarity.py "代码编辑? --limit 3 --details --verbose
```

## 输出格式

程序输出包含以下信息?
### 基本信息
- **OCR ID**：OCR结果的唯一标识?- **相似?*：文本与图像的语义相似度?-1之间，越高越相似?- **距离**：向量空间中的距离?- **图像路径**：图像文件的完整路径
- **文本内容**：OCR识别的文本内容（截取?00字符?
### 详细信息（使?--details 参数时）
- **应用程序**：截图时的应用程序名?- **窗口标题**：截图时的窗口标?- **创建时间**：截图创建时?- **置信?*：OCR识别的置信度
- **语言**：OCR识别的语言

## 示例输出

```
查询文本: 电脑

找到 5 个相关图?

--------------------------------------------------------------------------------
  1. OCR ID: 1
     相似? 0.3993 (距离: 1.5042)
     图像路径: C:\Users\PC\.lifetrace\screenshots\Snipaste_2025-08-19_21-37-15.jpg
     文本内容: ?36.4?00:40 【独家?《灵笼第二季》第12集预??月国创?     
     应用程序: Snipaste
     窗口标题: Snipaste截图 - Snipaste_2025-08-19_21-37-15.jpg
     创建时间: 2025-08-19T14:10:54
     置信? 0.8
     语言: ch
--------------------------------------------------------------------------------
```

## 相似度计算说?
程序使用以下公式计算相似度：

```
相似?= 1.0 / (1.0 + 距离)
```

这个公式的特点：
- 距离?时，相似度为1.0（完全相似）
- 距离越大，相似度越小，但永远不会?
- 能够处理距离大于1的情?
## 技术实?
1. **多模态嵌?*：使用CLIP模型生成文本和图像的向量表示
2. **向量搜索**：在图像向量数据库中进行相似度搜?3. **结果增强**：从关系数据库中获取完整的元数据信息
4. **排序输出**：按相似度降序排列结?
## 注意事项

1. **数据库依?*：程序需要LifeTrace系统已经收集并处理了图像数据
2. **模型加载**：首次运行时需要下载CLIP模型，可能需要一些时?3. **内存使用**：处理大量图像时可能消耗较多内?4. **查询语言**：支持中英文查询，建议使用与图像内容相关的语言

## 故障排除

### 常见错误

1. **"多模态向量服务未启用"**
   - 检查配置文件中的多模态设?   - 确保向量数据库已正确初始?
2. **"图像向量数据库中没有数据"**
   - 确保LifeTrace系统已经处理了一些截?   - 检查图像向量数据库的同步状?
3. **"无法生成查询文本的嵌?**
   - 检查CLIP模型是否正确加载
   - 确保网络连接正常（首次下载模型时?
### 调试建议

1. 使用 `--verbose` 参数查看详细日志
2. 检查数据库文件是否存在
3. 确认向量数据库目录的权限
4. 验证配置文件的正确?
## 扩展功能

程序可以进一步扩展：

1. **批量查询**：支持从文件读取多个查询
2. **结果导出**：将结果保存为JSON或CSV格式
3. **图像预览**：在终端中显示图像缩略图
4. **过滤功能**：按时间、应用程序等条件过滤结果
5. **交互模式**：支持连续查询而无需重新加载模型

## 性能优化

1. **缓存机制**：缓存常用查询的结果
2. **批处?*：支持批量处理多个查?3. **索引优化**：优化向量数据库的索引结?4. **内存管理**：优化大数据集的内存使用
